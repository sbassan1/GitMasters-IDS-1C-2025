<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="../../assets/style.css">
    <title>Lizard</title>
    <link rel="icon" href="../../images/lizard_logo_icon.ico">
</head>

<body>

  <body data-bs-theme="dark">
    <!--  Header -->
    <div class="container-fluid">
      <header
        class="d-flex flex-wrap align-items-center justify-content-center justify-content-around mb-4 border-bottom">
        <div class="col-md-3 mb-2 mb-md-0">
          <a href="main_user.html">
            <img src="../../images/lizard_logo_icon.ico" alt="Inicio" class="img-fluid rounded"
                style="width: 100px; height: 100px;">
          </a>
        </div>
        <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle px-4 li-header-black" href="#" id="dropdownMenuButton" role="button"
                data-bs-toggle="dropdown" aria-expanded="false">
                Productos</a>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><a class="dropdown-item" href="productos_user.html">Accesorios</a></li>
                <li><a class="dropdown-item" href="productos_user.html">Auriculares</a></li>
                <li><a class="dropdown-item" href="productos_user.html">Mouse</a></li>
                <li><a class="dropdown-item" href="productos_user.html">Teclados</a></li>
            </ul>
          </li>
          <li><a href="sucursales_user.html" class="nav-link px-4 li-header-black">Sucursales</a></li>
          <li><a href="contacto_user.html" class="nav-link px-4 li-header-black">Contacto</a></li>
        </ul>
            <div class="col-md-3 text-end">
                <div class="dropdown">
                    <button id="toggleTheme" class="btn btn-link">
                        <i id="themeIcon" class="bi bi-brightness-high-fill user-icon"></i>
                    </button>

                    <button class="btn btn-link" type="button" id="dropdownCart" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="bi bi-cart user-icon"></i>
                    </button>

                    <ul class="dropdown-menu" aria-labelledby="dropdownCart">
                        <li><a class="dropdown-item" href="#">Mi Carrito</a></li>
                        <li><a class="dropdown-item" href="#">Ver Productos</a></li>
                    </ul>
                    
                    <button class="btn btn-link" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="bi bi-person user-icon"></i>
                    </button>

                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <li><a class="dropdown-item" href="#">Iniciar sesión</a></li>
                        <li><a class="dropdown-item" href="#">Registrarse</a></li>
                    </ul>
                </div>
            </div>
      </header>
    </div>

    <!-- Contenedor del producto -->
    <div class="container my-5">
        <div class="mx-auto p-3">
            <div class="row g-0" style="justify-content: space-between !important;">
            <!-- Imagen del producto -->
            <div class="col-md-5 text-center">
                <img id="imagen-producto" src="/placeholder.svg?height=400&width=400" class="img-fluid rounded-start img-producto" alt="Producto" style="object-fit: contain;">
            </div>
        
            <!-- Detalles del producto -->
            <div class="col-md-7" style="max-width: 600px;">
                <div class="card-body mt-5">
                    <h3 class="mb-4" id="nombre">Cargando...</h3>
                    <p class="card-text" id="descripcion">Cargando descripción...</p>
                    
                    <p class="card-text">
                        <p class="form-label">Precio:  $<span id="precio">150,000</span></p>
                    </p>

                    <p class="card-text">
                        <small class="text-body-secondary">Stock: <span id="stock">50</span></small>
                    </p>
    
                    <!-- Selector de cantidad -->
                    <div class="mt-3 d-flex align-items-center gap-3">
                        <label for="cantidadInput" class="form-label mb-0">Cantidad</label>
                        <div class="input-group cantidad-selector" style="width: 140px;">
                            <button class="btn btn-outline-secondary boton-menos" type="button" onclick="cambiarCantidad(-1)">−</button>
                            <input type="number" id="cantidadInput" class="form-control text-center input-cantidad" value="1" min="1" readonly>
                            <button class="btn btn-outline-secondary boton-mas" type="button" onclick="cambiarCantidad(1)">+</button>
                        </div>
                    </div>
                
                    <!-- Añadir al carro -->
                    <a href="#"
                        class="btn btn-full-violet mt-5" style="width: 100% !important;">Añadir al carrito</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// Función para obtener el ID del producto desde la URL
function obtenerIdProducto() {
    const params = new URLSearchParams(window.location.search);
    return params.get("id");
}

// Función para construir URL de imagen de manera segura
function construirUrlImagen(rutaImagen) {
    if (!rutaImagen) return null;
    
    // Remover "backend/src/" del path
    const imagenPath = rutaImagen.replace('backend/src/', '');
    
    // Dividir la ruta en partes para codificar cada parte por separado
    const partesRuta = imagenPath.split('/');
    const rutaCodificada = partesRuta.map(parte => encodeURIComponent(parte)).join('/');
    
    return `http://localhost:3000/${rutaCodificada}`;
}

// Función para verificar si una imagen existe
async function verificarImagen(url) {
    try {
        const response = await fetch(url, { method: 'HEAD' });
        return response.ok;
    } catch (error) {
        return false;
    }
}

// Función para cargar los datos del producto desde la API
async function cargarProducto() {
    const idProducto = obtenerIdProducto();
    
    if (!idProducto) {
        document.getElementById("nombre").textContent = "Producto no encontrado";
        document.getElementById("descripcion").textContent = "No se especificó un producto válido.";
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/api/v1/productos/id/${idProducto}`);
        
        if (!response.ok) {
            throw new Error('Producto no encontrado');
        }
        
        const producto = await response.json();
        
        // Actualizar el contenido de la página
        document.getElementById("nombre").textContent = producto.nombre;
        document.getElementById("descripcion").textContent = producto.descripcion;
        document.getElementById("precio").textContent = producto.precio_venta.toLocaleString();
        document.getElementById("stock").textContent = producto.stock;
        
        // Actualizar la imagen si existe
        if (producto.imagen) {
            const imagenUrl = construirUrlImagen(producto.imagen);
            console.log('URL de imagen construida:', imagenUrl);
            
            // Verificar si la imagen existe antes de cargarla
            const imagenExiste = await verificarImagen(imagenUrl);
            
            if (imagenExiste) {
                document.getElementById("imagen-producto").src = imagenUrl;
                document.getElementById("imagen-producto").alt = producto.nombre;
            } else {
                console.warn('Imagen no encontrada:', imagenUrl);
                // Mantener la imagen placeholder si no se encuentra la imagen
            }
        }
        
        // Configurar el input de cantidad con el stock máximo
        const cantidadInput = document.getElementById('cantidadInput');
        cantidadInput.max = producto.stock;
        
        // Actualizar el enlace del botón "Añadir al carrito"
        const botonCarrito = document.querySelector('.btn-full-violet');
        botonCarrito.href = `#`; // Por ahora solo un placeholder
        
    } catch (error) {
        console.error('Error al cargar el producto:', error);
        document.getElementById("nombre").textContent = "Error al cargar producto";
        document.getElementById("descripcion").textContent = "No se pudo cargar la información del producto.";
    }
}

// Cargar el producto cuando se carga la página
document.addEventListener('DOMContentLoaded', cargarProducto);
</script>

    <!-- Bootstrap iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Bootstrap JS (incluye Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script modo oscuro / claro -->
    <script>
        const body = document.body;
        const toggleBtn = document.getElementById('toggleTheme');
        const icon = document.getElementById('themeIcon');

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            body.setAttribute('data-bs-theme', savedTheme);
            icon.className = savedTheme === 'dark'
                ? 'bi bi-brightness-high-fill user-icon'
                : 'bi bi-moon-fill user-icon';
        }

        toggleBtn.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-bs-theme');
            const isDark = currentTheme === 'dark';
            const newTheme = isDark ? 'light' : 'dark';

            body.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            icon.className = newTheme === 'dark'
                ? 'bi bi-brightness-high-fill user-icon'
                : 'bi bi-moon-fill user-icon';
        });
    </script>

    <!-- Script cantidad de productos -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const stock = parseInt(document.getElementById('stock').textContent);
            const input = document.getElementById('cantidadInput');
            input.max = stock;
        });

        function cambiarCantidad(delta) {
            const input = document.getElementById('cantidadInput');
            const min = parseInt(input.min);
            const max = parseInt(input.max);
            let valor = parseInt(input.value);

            valor = Math.min(max, Math.max(min, valor + delta));
            input.value = valor;
        }
    </script>
  </body>
</html>